<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Presensi QR</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/framework7/framework7-bundle.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/framework7-icons/css/framework7-icons.css"
    />

    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>

    <style>
      :root {
        --primary-color: #4a47a3;
        --secondary-color: #706fd3;
        --bg-color: #f7f9fc;
      }

      body {
        background-color: var(--bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          sans-serif;
      }

      .navbar-bg {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
      }
      .navbar .title,
      .navbar .link {
        color: white;
      }

      /* --- Event Card Style --- */
      .event-card {
        background: white;
        border-radius: 24px;
        padding: 30px 20px;
        box-shadow: 0 10px 30px rgba(74, 71, 163, 0.08);
        margin: 20px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      /* Hiasan background card */
      .event-card::before {
        content: "";
        position: absolute;
        top: -30px;
        right: -30px;
        width: 100px;
        height: 100px;
        background: radial-gradient(
          circle,
          rgba(112, 111, 211, 0.1) 0%,
          rgba(255, 255, 255, 0) 70%
        );
        border-radius: 50%;
      }

      .event-icon {
        width: 60px;
        height: 60px;
        background: #f0f0ff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        color: var(--primary-color);
      }

      .event-title {
        font-size: 1.4rem;
        font-weight: 700;
        color: #2d3436;
        margin: 0 0 5px;
      }

      .event-time {
        font-size: 0.95rem;
        color: #636e72;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }

      .status-chip {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        background: #e3fcf0;
        color: #00b894;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      /* --- Scan Button --- */
      .scan-container {
        padding: 0 20px;
        margin-top: 30px;
      }

      .btn-scan {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        height: 60px;
        border-radius: 18px;
        font-size: 1.1rem;
        font-weight: 700;
        box-shadow: 0 10px 25px rgba(74, 71, 163, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: white;
        width: 100%;
        border: none;
        transition: transform 0.2s;
        cursor: pointer;
      }
      .btn-scan:active {
        transform: scale(0.97);
      }

      .instruction-text {
        text-align: center;
        margin-top: 20px;
        color: #b2bec3;
        font-size: 0.85rem;
      }

      /* --- Scanner Popup Styles --- */
      #reader {
        width: 100%;
        border-radius: 20px;
        overflow: hidden;
        background: #000;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      }
      #reader__scan_region img {
        display: none;
      }
      #reader__dashboard_section_csr button {
        display: none;
      } /* Sembunyikan tombol bawaan library */
    </style>
  </head>

  <body>
    <div id="app">
      <div class="view view-main">
        <div class="page" data-name="presensi-qr">
          <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
              <div class="left">
                <a
                  href="../dashboard/dashboard-anggota.html"
                  class="link external text-color-white"
                >
                  <i class="icon material-icons">arrow_back</i>
                </a>
              </div>
              <div class="title text-color-white">Absensi QR Code</div>
            </div>
          </div>

          <div class="page-content">
            <div class="event-card">
              <div class="event-icon">
                <i class="f7-icons" style="font-size: 32px">calendar_today</i>
              </div>
              <h2 class="event-title" id="namaKegiatan">Memuat Kegiatan...</h2>
              <div class="event-time">
                <i class="f7-icons" style="font-size: 16px">clock</i>
                <span id="waktuKegiatan">-</span>
              </div>
              <div class="status-chip">
                <i class="f7-icons" style="font-size: 10px; margin-right: 4px"
                  >circle_fill</i
                >
                Sesi Aktif
              </div>
            </div>

            <div class="scan-container">
              <button class="btn-scan popup-open" data-popup=".popup-qr">
                <i class="material-icons">qr_code_scanner</i>
                MULAI SCAN
              </button>

              <div class="instruction-text">
                <p>
                  Pastikan Anda berada di lokasi kegiatan.<br />Arahkan kamera
                  ke kode QR Admin.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="popup popup-qr">
      <div class="view">
        <div class="page bg-color-black">
          <div class="navbar navbar-transparent">
            <div class="navbar-inner">
              <div class="right">
                <a
                  class="link popup-close text-color-white"
                  href="#"
                  onclick="stopScanner()"
                >
                  <i class="f7-icons">multiply_circle_fill</i>
                </a>
              </div>
            </div>
          </div>
          <div
            class="page-content display-flex flex-direction-column justify-content-center"
          >
            <div class="block text-align-center">
              <h2 class="text-color-white" style="font-weight: 700">
                Scanning...
              </h2>
              <p class="text-color-gray">
                Posisikan QR Code di dalam kotak area.
              </p>
            </div>

            <div class="block">
              <div id="reader"></div>
            </div>

            <div
              id="scan-feedback"
              class="block text-align-center text-color-white"
              style="display: none"
            >
              <div
                style="
                  background: rgba(255, 255, 255, 0.2);
                  width: 50px;
                  height: 50px;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  margin: 0 auto 10px;
                "
              >
                <span class="preloader color-white"></span>
              </div>
              <p>Memverifikasi Data...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/framework7/framework7-bundle.min.js"></script>
    <script>
      var app = new Framework7({ el: "#app", theme: "ios" }); // Pakai tema iOS agar lebih clean
      var $$ = Dom7;
      var html5QrcodeScanner = null;
      var activeEventName = "Presensi Harian";

      // === 1. CEK LOGIN & LOAD DATA ===
      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) {
        window.location.href = "../auth/login.html";
      }

      // Cek Event Hari Ini dari Firebase
      document.addEventListener("DOMContentLoaded", () => {
        if (window.firebase) {
          const db = firebase.database();
          const today = new Date().toISOString().split("T")[0];

          db.ref("kegiatan")
            .orderByChild("tanggal")
            .equalTo(today)
            .limitToLast(1)
            .once("value", (snap) => {
              if (snap.exists()) {
                const data = Object.values(snap.val())[0];
                document.getElementById("namaKegiatan").textContent = data.nama;
                document.getElementById("waktuKegiatan").textContent =
                  data.waktu + " WIB";
                activeEventName = data.nama;
              } else {
                document.getElementById("namaKegiatan").textContent =
                  "Absensi Harian";
                document.getElementById("waktuKegiatan").textContent =
                  new Date().toLocaleDateString("id-ID", {
                    weekday: "long",
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  });
              }
            });
        }
      });

      // === 2. LOGIKA SCANNER ===

      $$(document).on("popup:opened", ".popup-qr", function () {
        startScanner();
      });

      $$(document).on("popup:closed", ".popup-qr", function () {
        stopScanner();
      });

      function startScanner() {
        if (html5QrcodeScanner) return;

        html5QrcodeScanner = new Html5QrcodeScanner(
          "reader",
          {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            showTorchButtonIfSupported: true,
          },
          /* verbose= */ false
        );

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      }

      function stopScanner() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner
            .clear()
            .then(() => {
              html5QrcodeScanner = null;
            })
            .catch((err) => console.log("Stop error", err));
        }
      }

      // === 3. SAAT SCAN BERHASIL ===
      function onScanSuccess(decodedText, decodedResult) {
        stopScanner();
        document.getElementById("scan-feedback").style.display = "block";

        // Validasi Data QR
        try {
          let qrData = JSON.parse(decodedText);
          const today = new Date().toISOString().split("T")[0];

          if (qrData.tanggal !== today) {
            app.dialog.alert(
              "QR Code Kadaluarsa. Tanggal QR: " + qrData.tanggal,
              "Gagal"
            );
            app.popup.close(".popup-qr");
            document.getElementById("scan-feedback").style.display = "none";
            return;
          }
        } catch (e) {
          console.log("QR bukan JSON, lanjut proses manual...");
        }

        // Kirim ke Firebase
        kirimKehadiran();
      }

      function onScanFailure(error) {
        // Console log dimatikan agar tidak spam
      }

      function kirimKehadiran() {
        if (!window.firebase) {
          app.dialog.alert("Koneksi Database Gagal.");
          return;
        }

        const db = firebase.database();
        const today = new Date().toISOString().split("T")[0];
        const timeNow = new Date().toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const dataPresensi = {
          nama: currentUser.name,
          nim: currentUser.nim || "-",
          waktu: timeNow,
          status: "Hadir",
          kegiatan: activeEventName,
          metode: "QR Code",
        };

        db.ref("absensi/" + today)
          .push(dataPresensi)
          .then(() => {
            app.popup.close(".popup-qr");
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            app.dialog
              .create({
                title: "Absensi Berhasil!",
                text: `<div style="text-align:center; margin-top:10px;">
                      <i class="icon f7-icons text-color-green" style="font-size:50px">checkmark_circle_fill</i>
                      <p>Kehadiran Anda telah tercatat pada ${timeNow}.</p>
                     </div>`,
                buttons: [
                  {
                    text: "Selesai",
                    onClick: function () {
                      window.location.href =
                        "../dashboard/dashboard-anggota.html";
                    },
                  },
                ],
              })
              .open();
          })
          .catch((error) => {
            app.popup.close(".popup-qr");
            app.dialog.alert("Gagal mengirim data: " + error.message);
          });
      }
    </script>
  </body>
</html>
