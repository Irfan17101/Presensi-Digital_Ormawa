<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>BPM Smart Attendance</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <style>
      :root {
        --f7-theme-color: #4a47a3; /* Warna Tema BPM */
        --f7-page-bg-color: #f8f9fa;
      }

      /* Card Styles */
      .event-info-card {
        border-left: 5px solid var(--f7-theme-color);
        border-radius: 12px;
        background: #fff;
      }

      /* Camera Container Styles */
      #reader {
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        background: #000;
      }

      #selfie-video,
      #selfie-result {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
      }

      #selfie-result {
        transform: none;
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="view view-main view-init" data-url="/">
        <div class="page" data-name="presensi-bpm">
          <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
              <div class="left">
                <a href="../dashboard/dashboard-anggota.html" class="link external">
                  <i class="icon material-icons">arrow_back</i>
                </a>
              </div>
              <div class="title">Absensi BPM</div>
              <div class="right">
                <a
                  href="#"
                  class="link icon-only popup-open"
                  data-popup=".popup-notifikasi"
                >
                  <i class="icon material-icons">notifications</i>
                </a>
              </div>
            </div>
          </div>

          <div class="page-content">
            <div class="block-title margin-top">Sedang Berlangsung</div>
            <div class="card event-info-card shadow-lg margin-horizontal">
              <div class="card-content card-content-padding">
                <h2
                  style="
                    margin: 0;
                    color: var(--f7-theme-color);
                    font-size: 1.2rem;
                  "
                >
                  Sidang Pleno I
                </h2>
                <div class="list media-list no-hairlines" style="margin: 0">
                  <ul>
                    <li>
                      <div class="item-content" style="padding-left: 0">
                        <div class="item-media">
                          <i class="icon material-icons text-color-gray"
                            >event</i
                          >
                        </div>
                        <div class="item-inner">
                          <div class="item-title">Hari Ini, 17 Nov 2025</div>
                          <div class="item-subtitle">09:00 - Selesai</div>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="item-content" style="padding-left: 0">
                        <div class="item-media">
                          <i class="icon material-icons text-color-gray"
                            >place</i
                          >
                        </div>
                        <div class="item-inner">
                          <div class="item-title">Ruang Sidang SC</div>
                          <div
                            class="item-subtitle"
                            style="font-size: 11px; color: orange"
                          >
                            Radius Max: 5 Meter
                          </div>
                        </div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="block-title">Metode Absensi</div>
              <div class="row margin-horizontal gap-2">
                <div class="col-100 margin-bottom">
                  <button
                    class="button button-large button-fill popup-open"
                    data-popup=".popup-qr"
                    style="background: #000; height: 60px"
                  >
                    <i class="icon material-icons margin-right">qr_code_2</i>
                    Scan QR Code
                  </button>
                </div>

                <div class="col-100 margin-bottom">
                  <button
                    class="button button-large button-fill popup-open"
                    data-popup=".popup-selfie"
                    style="background: #e91e63; height: 60px"
                  >
                    <i class="icon material-icons margin-right">camera_front</i>
                    Verifikasi Selfie
                  </button>
                </div>
              </div>
            </div>
          </div>
                <div class="col-50">
                  <button
                    class="button button-fill popup-open ripple display-flex flex-direction-column justify-content-center align-items-center shadow-lg"
                    data-popup=".popup-selfie"
                    style="
                      height: 110px;
                      border-radius: 16px;
                      background: linear-gradient(
                        135deg,
                        #e91e63 0%,
                        #ff4081 100%
                      );
                      width: 100%;
                    "
                  >
                    <i
                      class="icon material-icons margin-bottom-half"
                      style="font-size: 32px; color: #fff"
                      >camera_front</i
                    >
                    <span style="font-size: 13px; font-weight: 600"
                      >Selfie</span
                    >
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="popup popup-qr">
      <div class="view">
        <div class="page bg-color-black">
          <div class="navbar navbar-transparent">
            <div class="navbar-inner">
              <div class="right">
                <a class="link popup-close text-color-white" href="#">Tutup</a>
              </div>
            </div>
          </div>
          <div
            class="page-content display-flex flex-direction-column justify-content-center align-items-center"
          >
            <h3 class="text-color-white">Scan QR Kegiatan</h3>
            <div
              id="reader"
              style="
                width: 300px;
                height: 300px;
                background: #fff;
                margin: 20px 0;
              "
            ></div>
            <p class="text-color-white text-align-center opacity-70">
              Arahkan kamera ke QR Code<br />yang disediakan panitia.
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="popup popup-selfie">
      <div class="view">
        <div class="page bg-color-black">
          <div class="navbar navbar-transparent">
            <div class="navbar-inner">
              <div class="title text-color-white">Ambil Selfie</div>
              <div class="right">
                <a class="link popup-close text-color-white" href="#">Batal</a>
              </div>
            </div>
          </div>
          <div class="page-content display-flex flex-direction-column">
            <div
              style="
                flex: 1;
                position: relative;
                overflow: hidden;
                background: #000;
              "
            >
              <video id="selfie-video" autoplay playsinline></video>
              <canvas id="selfie-canvas" style="display: none"></canvas>
              <img id="selfie-result" src="" />
            </div>

            <div
              style="
                height: 120px;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 20px;
              "
            >
              <button
                class="button button-fill color-white text-color-black ripple"
                id="btn-snap"
                onclick="takeSnapshot()"
                style="width: 70px; height: 70px; border-radius: 50%"
              >
                <i class="icon material-icons">camera_alt</i>
              </button>

              <button
                class="button button-fill color-green button-large button-round"
                id="btn-save-selfie"
                onclick="simpanSelfie()"
                style="display: none; min-width: 120px"
              >
                <i class="icon material-icons margin-right">send</i> Kirim
              </button>

              <button
                class="button button-outline color-white button-large button-round"
                id="btn-retake"
                onclick="resetSelfieCamera()"
                style="display: none"
              >
                Ulangi
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="popup popup-notifikasi">
      <div class="view">
        <div class="page">
          <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
              <div class="title">Notifikasi</div>
              <div class="right">
                <a class="link popup-close" href="#">Tutup</a>
              </div>
            </div>
          </div>
          <div class="page-content">
            <div class="block text-align-center text-color-gray margin-top">
              <i
                class="icon material-icons"
                style="font-size: 48px; opacity: 0.5"
                >notifications_off</i
              >
              <p>Tidak ada notifikasi baru.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/framework7@8/framework7-bundle.min.js"></script>

    <script>
      // Init App
      var app = new Framework7({
        el: "#app",
        name: "BPM Absen",
        id: "com.bpm.absen",
        theme: "md",
      });

      var $$ = Dom7;
      var html5QrcodeScanner = null;
      var selfieStream = null;

      // --- LOGIKA SCAN QR ---
      $$(document).on("popup:open", ".popup-qr", function () {
        startQrScanner();
      });

      $$(document).on("popup:close", ".popup-qr", function () {
        stopQrScanner();
      });

      function startQrScanner() {
        if (typeof Html5QrcodeScanner === "undefined") {
          app.dialog.alert("Gagal memuat library QR. Cek koneksi internet.");
          return;
        }
        html5QrcodeScanner = new Html5QrcodeScanner(
          "reader",
          { fps: 10, qrbox: { width: 250, height: 250 } },
          /* verbose= */ false
        );
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
      }

      function onScanSuccess(decodedText, decodedResult) {
        stopQrScanner();
        app.popup.close(".popup-qr");

        app.dialog.preloader("Verifikasi Data...");
        setTimeout(function () {
          app.dialog.close();
          app.dialog.alert(
            `Absensi Berhasil!<br>Kode: <b>${decodedText}</b>`,
            "Sukses"
          );
        }, 1000);
      }

      function onScanFailure(error) {}

      function stopQrScanner() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear().catch((e) => console.error(e));
          html5QrcodeScanner = null;
        }
      }

      // --- LOGIKA SELFIE ---
      $$(document).on("popup:open", ".popup-selfie", function () {
        initSelfieCamera();
      });

      $$(document).on("popup:close", ".popup-selfie", function () {
        stopSelfieStream();
        resetSelfieUI();
      });

      function initSelfieCamera() {
        var video = document.getElementById("selfie-video");
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({ video: { facingMode: "user" } })
            .then(function (stream) {
              selfieStream = stream;
              video.srcObject = stream;
              video.play();
            })
            .catch(function (err) {
              app.dialog.alert("Gagal akses kamera: " + err.message);
            });
        }
      }

      function stopSelfieStream() {
        if (selfieStream) {
          selfieStream.getTracks().forEach((track) => track.stop());
          selfieStream = null;
        }
      }

      function takeSnapshot() {
        var video = document.getElementById("selfie-video");
        var canvas = document.getElementById("selfie-canvas");
        var img = document.getElementById("selfie-result");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        var context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        var dataURL = canvas.toDataURL("image/png");
        img.src = dataURL;

        $$(video).hide();
        $$(img).show();
        $$("#btn-snap").hide();
        $$("#btn-save-selfie").show();
        $$("#btn-retake").show();
      }

      function resetSelfieCamera() {
        var video = document.getElementById("selfie-video");
        var img = document.getElementById("selfie-result");

        $$(video).show();
        $$(img).hide();
        $$("#btn-snap").show();
        $$("#btn-save-selfie").hide();
        $$("#btn-retake").hide();
      }

      function resetSelfieUI() {
        resetSelfieCamera();
        document.getElementById("selfie-result").src = "";
      }

      function simpanSelfie() {
        app.popup.close(".popup-selfie");
        app.dialog.preloader("Mengirim Foto...");
        setTimeout(function () {
          app.dialog.close();
          app.toast
            .create({
              text: "Foto Selfie Berhasil Diunggah!",
              position: "bottom",
              closeTimeout: 3000,
              cssClass: "bg-color-green",
            })
            .open();
        }, 1500);
      }
    </script>
  </body>
</html>
