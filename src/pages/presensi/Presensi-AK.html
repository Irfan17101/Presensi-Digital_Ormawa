<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Presensi HMA</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/framework7/framework7-bundle.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/framework7-icons/css/framework7-icons.css"
    />

    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="../../js/firebase-config.js"></script>

    <style>
      :root {
        --primary-color: #4a47a3;
        --secondary-color: #706fd3;
        --bg-color: #f7f9fc;
      }

      body {
        background-color: var(--bg-color);
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display",
          sans-serif;
      }
      .navbar-bg {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
      }
      .navbar .title,
      .navbar .link {
        color: white;
      }

      /* TICKET CARD STYLE */
      .ticket-card {
        background: white;
        border-radius: 20px;
        margin: 20px;
        box-shadow: 0 10px 30px rgba(74, 71, 163, 0.1);
        overflow: hidden;
        position: relative;
      }
      .ticket-header {
        background: #f0f0ff;
        padding: 20px;
        text-align: center;
        border-bottom: 2px dashed #dcdcf0;
        position: relative;
      }
      .ticket-header::before,
      .ticket-header::after {
        content: "";
        position: absolute;
        bottom: -10px;
        width: 20px;
        height: 20px;
        background: var(--bg-color);
        border-radius: 50%;
      }
      .ticket-header::before {
        left: -10px;
      }
      .ticket-header::after {
        right: -10px;
      }

      .event-title {
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--primary-color);
        margin: 10px 0 5px;
      }
      .event-status {
        display: inline-block;
        padding: 4px 12px;
        background: #e3fcf0;
        color: #00b894;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
      }

      .ticket-body {
        padding: 20px;
      }
      .info-row {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        color: #555;
      }
      .info-icon {
        width: 40px;
        height: 40px;
        background: #f7f7f7;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: var(--secondary-color);
      }
      .info-text label {
        display: block;
        font-size: 0.7rem;
        color: #999;
        margin-bottom: 2px;
      }
      .info-text span {
        font-weight: 600;
        font-size: 0.95rem;
      }

      /* SCAN BUTTON (SINGLE BIG BUTTON) */
      .scan-wrapper {
        padding: 0 20px;
        margin-top: 20px;
      }
      .btn-scan-big {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        height: 60px;
        width: 100%;
        border-radius: 16px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        box-shadow: 0 10px 25px rgba(74, 71, 163, 0.3);
        cursor: pointer;
        transition: transform 0.2s;
      }
      .btn-scan-big:active {
        transform: scale(0.97);
      }

      /* CAMERA POPUP */
      #reader {
        width: 100%;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        margin-bottom: 20px;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="view view-main">
        <div class="page" data-name="presensi-hma">
          <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner">
              <div class="left">
                <a
                  href="../dashboard/dashboard-anggota.html"
                  class="link external text-color-white"
                >
                  <i class="icon material-icons">arrow_back</i>
                </a>
              </div>
              <div class="title">Absensi AK</div>
            </div>
          </div>

          <div class="page-content">
            <div class="ticket-card">
              <div class="ticket-header">
                <div class="event-status">Sesi Aktif</div>
                <h2 class="event-title" id="namaKegiatan">Memuat Jadwal...</h2>
              </div>
              <div class="ticket-body">
                <div class="info-row">
                  <div class="info-icon"><i class="f7-icons">calendar</i></div>
                  <div class="info-text">
                    <label>TANGGAL & WAKTU</label>
                    <span id="waktuKegiatan">-</span>
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-icon">
                    <i class="f7-icons">placemark_fill</i>
                  </div>
                  <div class="info-text">
                    <label>LOKASI</label>
                    <span id="lokasiKegiatan">-</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="scan-wrapper">
              <button class="btn-scan-big popup-open" data-popup=".popup-qr">
                <i class="icon material-icons">qr_code_scanner</i>
                SCAN QR CODE
              </button>
              <p
                style="
                  text-align: center;
                  color: #999;
                  font-size: 12px;
                  margin-top: 15px;
                "
              >
                Arahkan kamera ke kode QR yang disediakan panitia HMA.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="popup popup-qr">
      <div class="view">
        <div class="page bg-color-black">
          <div class="navbar navbar-transparent">
            <div class="navbar-inner">
              <div class="right">
                <a
                  class="link popup-close text-color-white"
                  href="#"
                  onclick="stopScanner()"
                  >Tutup</a
                >
              </div>
            </div>
          </div>
          <div
            class="page-content display-flex flex-direction-column justify-content-center"
          >
            <div class="block text-align-center">
              <h3 class="text-color-white">Scan QR Code</h3>
              <p class="text-color-gray">Pastikan QR Code terlihat jelas.</p>
            </div>
            <div class="block">
              <div id="reader"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/framework7/framework7-bundle.min.js"></script>
    <script>
      var app = new Framework7({ el: "#app", theme: "ios" });
      var html5QrcodeScanner = null;
      var activeEventName = "Presensi HMA"; // Default

      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) window.location.href = "../auth/login.html";

      document.addEventListener("DOMContentLoaded", () => {
        if (window.firebase) {
          const db = firebase.database();
          const today = new Date().toISOString().split("T")[0];

          db.ref("kegiatan")
            .orderByChild("tanggal")
            .equalTo(today)
            .limitToLast(1)
            .once("value", (snap) => {
              if (snap.exists()) {
                const data = Object.values(snap.val())[0];
                document.getElementById("namaKegiatan").textContent = data.nama;
                document.getElementById(
                  "waktuKegiatan"
                ).textContent = `${data.waktu} WIB`;
                document.getElementById("lokasiKegiatan").textContent =
                  data.lokasi || "Lokasi Kegiatan";
                activeEventName = data.nama;
              } else {
                document.getElementById("namaKegiatan").textContent =
                  "Absensi Rutin HMA";
                document.getElementById("waktuKegiatan").textContent =
                  new Date().toLocaleDateString("id-ID");
                document.getElementById("lokasiKegiatan").textContent =
                  "Sekretariat HMA";
              }
            });
        }
      });

      // === LOGIKA SCANNER ===
      var $$ = Dom7;
      $$(document).on("popup:opened", ".popup-qr", function () {
        startScanner();
      });
      $$(document).on("popup:closed", ".popup-qr", function () {
        stopScanner();
      });

      function startScanner() {
        if (html5QrcodeScanner) return;
        html5QrcodeScanner = new Html5QrcodeScanner(
          "reader",
          { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
          false
        );
        html5QrcodeScanner.render(onScanSuccess, (err) => {});
      }

      function stopScanner() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner.clear().then(() => (html5QrcodeScanner = null));
        }
      }

      function onScanSuccess(decodedText) {
        stopScanner();
        app.popup.close(".popup-qr");

        try {
          let qrData = JSON.parse(decodedText);
          const today = new Date().toISOString().split("T")[0];
          if (qrData.tanggal !== today) {
            app.dialog.alert("QR Code Kadaluarsa/Salah Tanggal.", "Gagal");
            return;
          }
        } catch (e) {
          console.log("QR bukan JSON, lanjut...");
        }

        kirimKehadiran();
      }

      function kirimKehadiran() {
        if (!window.firebase) return;
        app.dialog.preloader("Menyimpan Data...");

        const db = firebase.database();
        const today = new Date().toISOString().split("T")[0];
        const timeNow = new Date().toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
        });

        const dataPresensi = {
          nama: currentUser.name,
          nim: currentUser.nim || "-",
          waktu: timeNow,
          status: "Hadir",
          kegiatan: activeEventName,
          metode: "QR Code",
        };

        db.ref("absensi/" + today)
          .push(dataPresensi)
          .then(() => {
            app.dialog.close();
            if (navigator.vibrate) navigator.vibrate([100]);
            app.dialog
              .create({
                title: "Berhasil!",
                text: `<div style="text-align:center;"><i class="f7-icons text-color-green" style="font-size:50px">checkmark_circle_fill</i><p>Kehadiran tercatat di<br><b>${activeEventName}</b></p></div>`,
                buttons: [
                  {
                    text: "OK",
                    onClick: () =>
                      (window.location.href =
                        "../dashboard/dashboard-anggota.html"),
                  },
                ],
              })
              .open();
          })
          .catch((error) => {
            app.dialog.close();
            app.dialog.alert("Gagal: " + error.message);
          });
      }
    </script>
  </body>
</html>
